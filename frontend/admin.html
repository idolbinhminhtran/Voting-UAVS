<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - The Vivid Dream</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Admin Dashboard Styles */
        body {
            background: var(--gray-50);
        }

        /* Admin Header */
        .admin-header {
            background: white;
            border-bottom: 1px solid var(--gray-200);
            padding: var(--spacing-lg) 0;
            margin-top: 72px;
            position: sticky;
            top: 72px;
            z-index: 100;
            box-shadow: var(--shadow-sm);
        }

        .admin-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .admin-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0;
        }

        .admin-user {
            display: flex;
            align-items: center;
            gap: var(--spacing-lg);
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-weight: 600;
            color: var(--gray-900);
        }

        .user-role {
            font-size: 0.875rem;
            color: var(--gray-500);
        }

        /* Admin Navigation Tabs */
        .admin-tabs {
            display: flex;
            gap: var(--spacing-sm);
            border-bottom: 2px solid var(--gray-200);
            margin-top: var(--spacing-lg);
            overflow-x: auto;
        }
        
        .admin-tab {
            padding: var(--spacing-md) var(--spacing-xl);
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--gray-600);
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
            position: relative;
        }
        
        .admin-tab:hover {
            color: var(--primary-color);
            background: var(--gray-50);
        }
        
        .admin-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background: white;
        }

        .admin-tab-icon {
            margin-right: var(--spacing-sm);
        }

        /* Dashboard Content */
        .admin-content {
            display: none;
            animation: fadeIn 0.4s ease-out;
            padding: var(--spacing-2xl) 0;
        }
        
        .admin-content.active {
            display: block;
        }
        
        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-2xl);
        }
        
        .stat-card {
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
            transition: all var(--transition-base);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary-gradient);
        }

        .stat-icon {
            width: 56px;
            height: 56px;
            background: var(--gray-100);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: var(--spacing-lg);
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--gray-900);
            margin-bottom: var(--spacing-sm);
            line-height: 1;
        }
        
        .stat-label {
            color: var(--gray-600);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.875rem;
            font-weight: 600;
            margin-top: var(--spacing-md);
        }

        .stat-change.positive {
            color: var(--success-color);
        }

        .stat-change.negative {
            color: var(--danger-color);
        }

        .stat-change.neutral {
            color: var(--gray-500);
        }

        /* Chart Container */
        .chart-container {
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
            margin-bottom: var(--spacing-2xl);
        }

        .chart-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-xl);
        }

        .chart-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin: 0;
        }

        /* Results Table */
        .results-table-container {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
            overflow: hidden;
        }

        .table-header {
            padding: var(--spacing-xl);
            border-bottom: 1px solid var(--gray-200);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--gray-50);
            padding: var(--spacing-md) var(--spacing-lg);
            text-align: left;
            font-weight: 600;
            color: var(--gray-700);
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .table td {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--gray-100);
        }

        .table tr:hover {
            background: var(--gray-50);
        }

        .contestant-cell {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .contestant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }

        .contestant-rank {
            width: 32px;
            height: 32px;
            background: var(--gray-100);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--gray-700);
        }

        .contestant-rank.gold {
            background: linear-gradient(135deg, #FFD700, #FFA500);
            color: white;
        }

        .contestant-rank.silver {
            background: linear-gradient(135deg, #C0C0C0, #808080);
            color: white;
        }

        .contestant-rank.bronze {
            background: linear-gradient(135deg, #CD7F32, #B87333);
            color: white;
        }

        .vote-bar {
            position: relative;
            background: var(--gray-100);
            height: 8px;
            border-radius: var(--radius-full);
            overflow: hidden;
            margin-top: var(--spacing-sm);
        }
        
        .vote-bar-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background: var(--primary-gradient);
            transition: width 1s ease-out;
        }

        /* Action Buttons */
        .action-card {
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
            margin-bottom: var(--spacing-xl);
        }

        .action-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
        }

        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-lg);
            background: var(--gray-50);
            border: 2px solid var(--gray-200);
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: all var(--transition-base);
            text-decoration: none;
            color: var(--gray-700);
        }

        .action-button:hover {
            background: white;
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .action-button-icon {
            font-size: 2rem;
            color: var(--primary-color);
        }

        .action-button-text {
            font-weight: 600;
            text-align: center;
        }

        /* Danger Zone */
        .danger-zone {
            background: linear-gradient(135deg, #FEF2F2 0%, #FEE2E2 100%);
            border: 2px solid var(--danger-color);
            border-radius: var(--radius-xl);
            padding: var(--spacing-2xl);
            margin-top: var(--spacing-3xl);
            position: relative;
        }

        .danger-zone::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: repeating-linear-gradient(
                45deg,
                var(--danger-color),
                var(--danger-color) 10px,
                transparent 10px,
                transparent 20px
            );
        }

        .danger-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .danger-icon {
            font-size: 2rem;
            color: var(--danger-color);
        }

        .danger-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--danger-color);
            margin: 0;
        }

        .danger-description {
            color: var(--gray-700);
            margin-bottom: var(--spacing-xl);
            background: white;
            padding: var(--spacing-md);
            border-radius: var(--radius-md);
            border-left: 4px solid var(--warning-color);
        }

        .danger-actions {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        /* Ticket Stats */
        .ticket-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--spacing-xl);
        }

        .ticket-stat-card {
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--gray-100);
        }

        .ticket-list {
            max-height: 400px;
            overflow-y: auto;
            margin-top: var(--spacing-lg);
        }

        .ticket-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--gray-100);
        }

        .ticket-item:hover {
            background: var(--gray-50);
        }

        .ticket-code {
            font-family: monospace;
            font-weight: 600;
            color: var(--gray-900);
        }

        .ticket-status {
            font-size: 0.875rem;
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-full);
        }

        .ticket-status.used {
            background: var(--success-bg);
            color: var(--success-color);
        }

        .ticket-status.unused {
            background: var(--gray-100);
            color: var(--gray-600);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-header-content {
                flex-direction: column;
                gap: var(--spacing-md);
                text-align: center;
            }
            
            .admin-tabs {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .danger-actions {
                flex-direction: column;
            }

            .action-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="/" class="navbar-brand">
                <i class="fas fa-star"></i>
                The Vivid Dream
            </a>
            <ul class="navbar-menu">
                <li><a href="/" class="navbar-link">Home</a></li>
                <li><a href="/voting" class="navbar-link">Vote Now</a></li>
                <li><a href="/admin-login" class="navbar-link">Admin</a></li>
            </ul>
            </div>
    </nav>

    <!-- Admin Header -->
    <div class="admin-header">
        <div class="container admin-header-content">
            <h1 class="admin-title">Admin Dashboard</h1>
            <div class="admin-user">
                <div class="user-info">
                    <div class="user-name" id="adminUsername">Admin User</div>
                    <div class="user-role">Administrator</div>
                </div>
                <button class="btn btn-secondary btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    Logout
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Admin Tabs -->
        <div class="admin-tabs">
            <button class="admin-tab active" onclick="showTab('dashboard')">
                <i class="fas fa-chart-line admin-tab-icon"></i>
                Dashboard
            </button>
            <button class="admin-tab" onclick="showTab('results')">
                <i class="fas fa-trophy admin-tab-icon"></i>
                Results
            </button>
            <button class="admin-tab" onclick="showTab('tickets')">
                <i class="fas fa-ticket-alt admin-tab-icon"></i>
                Tickets
            </button>
            <button class="admin-tab" onclick="showTab('settings')">
                <i class="fas fa-cog admin-tab-icon"></i>
                Settings
            </button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboard" class="admin-content active">
            <!-- Statistics -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-ticket-alt"></i>
                    </div>
                    <div class="stat-value" id="totalTickets">-</div>
                    <div class="stat-label">Total Tickets</div>
                    <div class="stat-change positive" id="ticketStatus">
                        <i class="fas fa-arrow-up"></i>
                        <span>Loading...</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-value" id="usedTickets">-</div>
                    <div class="stat-label">Used Tickets</div>
                    <div class="stat-change positive" id="usageRate">
                        <i class="fas fa-chart-line"></i>
                        <span>0% Usage Rate</span>
                </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-vote-yea"></i>
                    </div>
                    <div class="stat-value" id="totalVotes">-</div>
                    <div class="stat-label">Total Votes</div>
                    <div class="stat-change positive" id="voteStatus">
                        <i class="fas fa-users"></i>
                        <span>Loading...</span>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-value" id="votingStatus">OPEN</div>
                    <div class="stat-label">Voting Status</div>
                    <div class="stat-change positive" id="votingStatusIndicator">
                        <i class="fas fa-circle"></i>
                        <span>Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="action-card">
                <h3 class="mb-3">Quick Actions</h3>
                <div class="action-grid">
                    <a href="#" class="action-button" onclick="exportData('tickets')">
                        <i class="fas fa-download action-button-icon"></i>
                        <span class="action-button-text">Export Tickets</span>
                    </a>
                    <a href="#" class="action-button" onclick="exportData('results')">
                        <i class="fas fa-file-excel action-button-icon"></i>
                        <span class="action-button-text">Export Results</span>
                    </a>
                    <a href="#" class="action-button" onclick="refreshStats()">
                        <i class="fas fa-sync-alt action-button-icon"></i>
                        <span class="action-button-text">Refresh Stats</span>
                    </a>
                    <a href="#" class="action-button" onclick="showTab('settings')">
                        <i class="fas fa-cogs action-button-icon"></i>
                        <span class="action-button-text">System Settings</span>
                    </a>
                </div>
            </div>

            <!-- Live Vote Chart -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3 class="chart-title">Live Voting Progress</h3>
                    <button class="btn btn-secondary btn-sm" onclick="refreshChart()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh
                    </button>
                </div>
                <div id="votingChart" style="height: 300px; display: flex; align-items: center; justify-content: center;">
                    <div class="text-muted">
                        <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                        Loading chart data...
                    </div>
                </div>
            </div>
        </div>

        <!-- Results Tab -->
        <div id="results" class="admin-content">
            <div class="results-table-container">
                <div class="table-header">
                    <h3 class="m-0">Voting Results</h3>
                    <button class="btn btn-primary btn-sm" onclick="refreshResults()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh Results
                    </button>
                </div>
                <div id="resultsTableContainer">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Contestant</th>
                                <th>Votes</th>
                                <th>Percentage</th>
                                <th>Progress</th>
                            </tr>
                        </thead>
                        <tbody id="resultsTableBody">
                            <tr>
                                <td colspan="5" class="text-center text-muted p-4">
                                    <i class="fas fa-spinner fa-spin"></i> Loading results...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Tickets Tab -->
        <div id="tickets" class="admin-content">
            <div class="ticket-grid">
                <div class="ticket-stat-card">
                    <h3>Ticket Overview</h3>
                    <div class="stats-grid" style="margin-top: var(--spacing-lg);">
                        <div>
                            <div class="stat-value" id="ticketTotalGenerated" style="font-size: 2rem;">-</div>
                            <div class="stat-label">Total Generated</div>
                        </div>
                        <div>
                            <div class="stat-value" id="ticketUsed" style="font-size: 2rem; color: var(--success-color);">-</div>
                            <div class="stat-label">Used</div>
                        </div>
                        <div>
                            <div class="stat-value" id="ticketUnused" style="font-size: 2rem; color: var(--warning-color);">-</div>
                            <div class="stat-label">Unused</div>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button class="btn btn-primary w-100" onclick="syncPredefinedTickets()">
                            <i class="fas fa-sync-alt"></i>
                            Sync with Supabase
                        </button>
                    </div>
                </div>
                
                
            </div>
        </div>

        <!-- Settings Tab -->
        <div id="settings" class="admin-content">
            <div class="card">
                <div class="card-body">
                    <h3 class="mb-4">System Settings</h3>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle alert-icon"></i>
                        <div>
                            <strong>Voting Status:</strong> <span id="votingStatusText">Loading...</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Voting Status Control</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="toggleVoting(true)">
                                <i class="fas fa-play"></i>
                                Open Voting
                            </button>
                            <button class="btn btn-danger" onclick="toggleVoting(false)">
                                <i class="fas fa-stop"></i>
                                Close Voting
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="danger-zone">
                <div class="danger-header">
                    <i class="fas fa-exclamation-triangle danger-icon"></i>
                    <h2 class="danger-title">Danger Zone</h2>
                </div>
                <p class="danger-description">
                    <i class="fas fa-warning"></i> 
                    <strong>Warning:</strong> These actions are irreversible and will permanently affect the voting system. 
                    Please ensure you have proper backups before proceeding.
                </p>
                <div class="danger-actions">
                    <button class="btn btn-danger" onclick="confirmResetVoting()">
                        <i class="fas fa-trash-alt"></i>
                        Reset All Voting Data
                    </button>
                    <button class="btn btn-warning" onclick="syncPredefinedTickets()">
                        <i class="fas fa-sync-alt"></i>
                        Re-sync with Supabase
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-backdrop" id="confirmBackdrop"></div>
    <div class="modal" id="confirmModal">
            <div class="modal-header">
            <h3 class="modal-title" id="confirmTitle">Confirm Action</h3>
            </div>
            <div class="modal-body">
                <p id="confirmMessage"></p>
            </div>
            <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeConfirmModal()">Cancel</button>
            <button class="btn btn-danger" id="confirmButton">Confirm</button>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Check authentication on load
        window.addEventListener('DOMContentLoaded', async function() {
            try {
                const response = await fetch('/api/admin/status', {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (!data.authenticated) {
                    window.location.href = '/admin-login';
                    return;
                }
                
                // Update username
                document.getElementById('adminUsername').textContent = data.username || 'Admin';
                
                // Load initial data
                loadDashboardData();
                
            } catch (error) {
                console.error('Authentication check failed:', error);
                window.location.href = '/admin-login';
            }
        });
        
        // Tab switching
        function showTab(tabName) {
            // Update tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update content
            document.querySelectorAll('.admin-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');
            
            // Load tab-specific data
            switch(tabName) {
                case 'dashboard':
                    loadDashboardData();
                    break;
                case 'results':
                    loadResults();
                    break;
                case 'tickets':
                    loadTicketStats();
                    break;
            }
        }
        
        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Load stats
                const [resultsRes, ticketsRes] = await Promise.all([
                    fetch('/api/results'),
                    fetch('/api/ticket/stats', { credentials: 'include' })
                ]);
                
                const results = await resultsRes.json();
                const tickets = await ticketsRes.json();
                
                // Update stats
                document.getElementById('totalVotes').textContent = results.total_votes || 0;
                document.getElementById('votingStatus').textContent = results.voting_open ? 'OPEN' : 'CLOSED';
                
                document.getElementById('totalTickets').textContent = tickets.total_tickets || 0;
                document.getElementById('usedTickets').textContent = tickets.used_tickets || 0;
                
                // Calculate usage rate
                const usageRate = tickets.total_tickets > 0 
                    ? Math.round((tickets.used_tickets / tickets.total_tickets) * 100) 
                    : 0;
                document.getElementById('usageRate').innerHTML = 
                    `<i class="fas fa-chart-line"></i> <span>${usageRate}% Usage Rate</span>`;
                
                // Update ticket status
                const predefinedCount = tickets.total_tickets || 0;
                const syncedCount = tickets.synced_to_db || 0;
                if (syncedCount > 0) {
                    document.getElementById('ticketStatus').innerHTML = 
                        `<i class="fas fa-check-circle"></i> <span>${syncedCount} Synced</span>`;
                    document.getElementById('ticketStatus').className = 'stat-change positive';
                } else {
                    document.getElementById('ticketStatus').innerHTML = 
                        `<i class="fas fa-exclamation-triangle"></i> <span>Not Synced</span>`;
                    document.getElementById('ticketStatus').className = 'stat-change negative';
                }
                
                // Update vote status
                const totalVotes = results.total_votes || 0;
                if (totalVotes > 0) {
                    document.getElementById('voteStatus').innerHTML = 
                        `<i class="fas fa-users"></i> <span>${totalVotes} Votes Cast</span>`;
                    document.getElementById('voteStatus').className = 'stat-change positive';
                } else {
                    document.getElementById('voteStatus').innerHTML = 
                        `<i class="fas fa-clock"></i> <span>No Votes Yet</span>`;
                    document.getElementById('voteStatus').className = 'stat-change neutral';
                }
                
                // Update voting status style
                const statusElement = document.querySelector('#votingStatus').parentElement;
                if (results.voting_open) {
                    statusElement.querySelector('.stat-change').className = 'stat-change positive';
                    document.getElementById('votingStatusIndicator').innerHTML = 
                        `<i class="fas fa-circle"></i> <span>Live Now</span>`;
                } else {
                    statusElement.querySelector('.stat-change').className = 'stat-change negative';
                    document.getElementById('votingStatusIndicator').innerHTML = 
                        `<i class="fas fa-circle"></i> <span>Closed</span>`;
                }
                
            } catch (error) {
                console.error('Error loading dashboard data:', error);
            }
        }

        // Load results
        async function loadResults() {
            try {
                const response = await fetch('/api/results');
                const data = await response.json();
                
                if (data.results && data.results.length > 0) {
                    const tbody = document.getElementById('resultsTableBody');
                    tbody.innerHTML = data.results.map((result, index) => {
                        // API returns vote_count and percentage fields from the voting_results view
                        const voteCount = typeof result.vote_count !== 'undefined' ? result.vote_count : (result.votes || 0);
                        const percentage = typeof result.percentage !== 'undefined'
                            ? Number(result.percentage)
                            : (data.total_votes > 0 ? Math.round((voteCount / data.total_votes) * 100) : 0);
                        
                        let rankClass = '';
                        if (index === 0) rankClass = 'gold';
                        else if (index === 1) rankClass = 'silver';
                        else if (index === 2) rankClass = 'bronze';
                        
                        return `
                            <tr>
                                <td>
                                    <div class="contestant-rank ${rankClass}">${index + 1}</div>
                                </td>
                                <td>
                                    <div class="contestant-cell">
                                        <img src="${result.image_url || '/images/default-avatar.svg'}" 
                                             alt="${result.name}" 
                                             class="contestant-avatar"
                                             onerror="this.src='/images/default-avatar.svg'">
                                        <div>
                                            <div class="fw-semibold">${result.name}</div>
                                        </div>
                                    </div>
                                </td>
                                <td class="fw-bold">${voteCount}</td>
                                <td>${percentage}%</td>
                                <td style="width: 200px;">
                                    <div class="vote-bar">
                                        <div class="vote-bar-fill" style="width: ${percentage}%"></div>
                                    </div>
                                </td>
                            </tr>
                        `;
                    }).join('');
                } else {
                    document.getElementById('resultsTableBody').innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center text-muted p-4">
                                No voting results available yet
                            </td>
                        </tr>
                    `;
                }
            } catch (error) {
                console.error('Error loading results:', error);
            }
        }

        // Logout function
        async function logout() {
            try {
                const response = await fetch('/api/admin/logout', {
                    method: 'POST',
                credentials: 'include'
                });
                
                if (response.ok) {
                        window.location.href = '/admin-login';
                }
            } catch (error) {
                console.error('Logout error:', error);
            }
        }

        // Refresh functions
        function refreshStats() {
            loadDashboardData();
        }

        function refreshResults() {
            loadResults();
        }

        function refreshChart() {
            // Placeholder for chart refresh
            document.getElementById('votingChart').innerHTML = `
                <div class="text-muted">
                    <i class="fas fa-chart-bar" style="font-size: 3rem; margin-bottom: 1rem; display: block;"></i>
                    Chart refreshed!
                </div>
            `;
        }

        // Confirmation modal
        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmButton').onclick = function() {
                closeConfirmModal();
                onConfirm();
            };
            document.getElementById('confirmBackdrop').classList.add('show');
            document.getElementById('confirmModal').classList.add('show');
        }

        function closeConfirmModal() {
            document.getElementById('confirmBackdrop').classList.remove('show');
            document.getElementById('confirmModal').classList.remove('show');
        }

        // Danger zone actions
        function confirmResetVoting() {
            showConfirmModal(
                'Reset All Voting Data',
                'Are you sure you want to reset all voting data? This will delete all votes and cannot be undone.',
                resetVoting
            );
        }

        async function resetVoting() {
            try {
                const response = await fetch('/api/admin/reset-voting', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Success: ${data.message}`);
                    // Refresh all data after reset
                    loadDashboardData();
                    loadTicketStats();
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error resetting voting:', error);
                alert('Failed to reset voting data');
            }
        }

        // Export functions
        function exportData(type) {
            alert(`Exporting ${type} data (not implemented in this demo)`);
        }

        function exportTickets(type) {
            alert(`Exporting ${type} tickets (not implemented in this demo)`);
        }

        // Sync pre-defined tickets
        async function syncPredefinedTickets() {
            try {
                const response = await fetch('/api/admin/sync-predefined-tickets', {
                    method: 'POST',
                    credentials: 'include'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(`Success: ${data.message}\nTotal pre-defined: ${data.total_predefined}\nNewly synced: ${data.newly_synced}`);
                    loadTicketStats(); // Refresh ticket stats
                } else {
                    alert(`Error: ${data.error}`);
                }
            } catch (error) {
                console.error('Error syncing tickets:', error);
                alert('Failed to sync pre-defined tickets');
            }
        }

        // Toggle voting
        async function toggleVoting(open) {
            try {
                const endpoint = open ? '/api/admin/voting-open' : '/api/admin/voting-close';
                const response = await fetch(endpoint, { method: 'POST', credentials: 'include' });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Request failed');
                await refreshVotingStatus();
                alert(data.message || (open ? 'Voting opened' : 'Voting closed'));
            } catch (e) {
                console.error('Toggle voting error:', e);
                alert('Failed to update voting status');
            }
        }

        async function refreshVotingStatus() {
            try {
                const response = await fetch('/api/admin/voting-status', { credentials: 'include' });
                const data = await response.json();
                const el = document.getElementById('votingStatusText');
                if (el) el.innerHTML = data.voting_open ? '<strong>OPEN</strong>' : '<strong>CLOSED</strong>';
            } catch (e) {
                const el = document.getElementById('votingStatusText');
                if (el) el.textContent = 'Unknown';
            }
        }

        // Load status at startup
        refreshVotingStatus();

        // Load ticket stats (placeholder)
        function loadTicketStats() {
            fetch('/api/ticket/stats', {
                credentials: 'include'
            })
                .then(response => response.json())
                .then(data => {
                    if (!data) return;
                    const total = data.total_tickets ?? 0;
                    const used = data.used_tickets ?? 0;
                    const unused = data.unused_tickets ?? Math.max(total - used, 0);

                    const setText = (id, value) => {
                        const el = document.getElementById(id);
                        if (el) el.textContent = value;
                    };

                    setText('ticketTotalGenerated', total);
                    setText('ticketUsed', used);
                    setText('ticketUnused', unused);
                })
                .catch(err => {
                    console.error('Error loading ticket overview:', err);
                });
        }
    </script>
</body>
</html>

