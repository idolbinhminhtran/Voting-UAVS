<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vote Now - The Vivid Dream UGT 25</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Page Background */
        body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
        }

        /* Page Header */
        .page-header {
            background: var(--primary-gradient);
            padding: var(--spacing-3xl) 0;
            margin-top: 72px;
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: rotate 30s linear infinite;
        }

        @keyframes rotate {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .page-header-content {
            position: relative;
            z-index: 2;
            text-align: center;
            color: white;
        }

        .page-title {
            font-size: clamp(2.5rem, 5vw, 3.5rem);
            font-weight: 800;
            margin-bottom: var(--spacing-md);
            animation: fadeIn 0.6s ease-out;
        }

        .page-subtitle {
            font-size: 1.25rem;
            opacity: 0.9;
            font-weight: 300;
            animation: fadeIn 0.6s ease-out 0.2s both;
        }

        /* Voting Process Steps */
        .voting-steps {
            display: flex;
            justify-content: center;
            margin: calc(var(--spacing-3xl) * -1) auto var(--spacing-3xl);
            position: relative;
            z-index: 10;
        }

        .steps-container {
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            padding: var(--spacing-xl);
            display: flex;
            gap: var(--spacing-2xl);
            align-items: center;
        }

        .step {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            position: relative;
        }

        .step:not(:last-child)::after {
            content: '';
            position: absolute;
            right: calc(var(--spacing-2xl) * -1 + var(--spacing-md));
            width: calc(var(--spacing-2xl) - var(--spacing-md) * 2);
            height: 2px;
            background: var(--gray-200);
            top: 50%;
            transform: translateY(-50%);
        }

        .step.active .step-number {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 12px rgba(94, 58, 238, 0.3);
        }

        .step.completed .step-number {
            background: var(--success-color);
            color: white;
        }

        .step.completed::after {
            background: var(--success-color);
        }

        .step-number {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--gray-200);
            color: var(--gray-500);
            font-weight: 700;
            font-size: 1.25rem;
            transition: all var(--transition-base);
        }

        .step-text {
            display: flex;
            flex-direction: column;
        }

        .step-label {
            font-size: 0.875rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .step-title {
            font-weight: 600;
            color: var(--gray-900);
        }

        /* Ticket Verification Section */
        .ticket-section {
            background: white;
            border-radius: var(--radius-xl);
            padding: var(--spacing-2xl);
            margin-bottom: var(--spacing-2xl);
            box-shadow: var(--shadow-md);
            animation: fadeIn 0.6s ease-out 0.4s both;
        }

        .ticket-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-xl);
        }

        .ticket-icon {
            width: 56px;
            height: 56px;
            background: var(--primary-gradient);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .ticket-title {
            flex: 1;
        }

        .ticket-title h3 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--gray-900);
        }

        .ticket-title p {
            margin: 0;
            color: var(--gray-600);
            font-size: 0.875rem;
        }

        .ticket-input-group {
            display: flex;
            gap: var(--spacing-md);
            align-items: flex-end;
            margin-bottom: var(--spacing-lg);
        }

        .ticket-input-wrapper {
            flex: 1;
            max-width: 400px;
        }

        .ticket-input {
            font-size: 1.25rem;
            font-weight: 600;
            text-align: center;
            letter-spacing: 0.2em;
            text-transform: uppercase;
            padding: var(--spacing-lg);
            border: 3px solid var(--gray-200);
            transition: all var(--transition-base);
        }

        .ticket-input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 4px rgba(94, 58, 238, 0.1);
        }

        .ticket-status {
            margin-top: var(--spacing-md);
            padding: var(--spacing-lg);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            font-weight: 500;
            animation: slideInRight 0.4s ease-out;
        }

        .ticket-status.valid {
            background: var(--success-bg);
            color: var(--success-color);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .ticket-status.invalid {
            background: var(--danger-bg);
            color: var(--danger-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Contestants Section */
        .contestants-section {
            animation: fadeIn 0.6s ease-out 0.6s both;
        }

        .contestants-header {
            text-align: center;
            margin-bottom: var(--spacing-2xl);
        }

        .contestants-header h2 {
            font-size: 2.5rem;
            margin-bottom: var(--spacing-md);
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .contestants-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--spacing-xl);
            margin-bottom: var(--spacing-2xl);
        }

        .contestant-card {
            background: white;
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-md);
            transition: all var(--transition-base);
            cursor: pointer;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .contestant-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-xl);
        }

        .contestant-card.selected {
            box-shadow: 0 0 0 4px var(--primary-color);
            transform: translateY(-8px);
        }

        .contestant-card.selected::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary-gradient);
            opacity: 0.05;
            z-index: 1;
        }

        .contestant-card.selected .selection-badge {
            opacity: 1;
            transform: scale(1);
        }

        .selection-badge {
            position: absolute;
            top: var(--spacing-md);
            right: var(--spacing-md);
            background: var(--primary-gradient);
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            z-index: 10;
            opacity: 0;
            transform: scale(0);
            transition: all var(--transition-base);
        }

        .contestant-image {
            width: 100%;
            height: 280px;
            object-fit: cover;
            object-position: center 20%;
            transition: all var(--transition-base);
        }

        .contestant-card:hover .contestant-image {
            transform: scale(1.05);
        }

        .contestant-info {
            padding: var(--spacing-xl);
            position: relative;
            z-index: 2;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .contestant-number {
            display: inline-block;
            background: var(--gray-100);
            color: var(--gray-600);
            padding: var(--spacing-xs) var(--spacing-md);
            border-radius: var(--radius-full);
            font-size: 0.875rem;
            font-weight: 600;
            margin-bottom: var(--spacing-md);
        }

        .contestant-name {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            color: var(--gray-900);
        }


        .vote-button {
            width: 100%;
            background: var(--gray-100);
            color: var(--gray-600);
            padding: var(--spacing-md);
            border: none;
            border-radius: var(--radius-lg);
            font-weight: 600;
            cursor: not-allowed;
            transition: all var(--transition-base);
        }

        .vote-button.enabled {
            background: var(--primary-gradient);
            color: white;
            cursor: pointer;
        }

        .vote-button.enabled:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(94, 58, 238, 0.3);
        }

        /* Submit Section */
        .submit-section {
            text-align: center;
            padding: var(--spacing-3xl);
            background: white;
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            margin-top: var(--spacing-2xl);
        }

        .submit-button {
            font-size: 1.25rem;
            padding: var(--spacing-lg) var(--spacing-3xl);
            box-shadow: 0 8px 24px rgba(94, 58, 238, 0.3);
        }

        .submit-button:disabled {
            background: var(--gray-300);
            box-shadow: none;
        }

        /* Loading State */
        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-3xl);
            gap: var(--spacing-lg);
        }

        .loading-text {
            color: var(--gray-600);
            font-size: 1.125rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .steps-container {
                flex-direction: column;
                gap: var(--spacing-lg);
                padding: var(--spacing-lg);
                align-items: flex-start; /* left align items on mobile */
                width: 100%;
            }

            .step::after {
                display: none;
            }

            /* Make each step full width and left-aligned on mobile */
            .step {
                width: 100%;
                justify-content: flex-start;
            }

            .step-text {
                text-align: left;
            }

            .ticket-input-group {
                flex-direction: column;
            }

            .ticket-input-wrapper {
                max-width: 100%;
            }

            .contestants-grid {
                grid-template-columns: 1fr;
            }

            .page-title {
                font-size: 2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="/" class="navbar-brand">
                <i class="fas fa-star"></i>
                The Vivid Dream
            </a>
            <ul class="navbar-menu">
                <li><a href="/" class="navbar-link">Home</a></li>
                <li><a href="/voting" class="navbar-link">Vote Now</a></li>
                <li><a href="/admin-login" class="navbar-link">Admin</a></li>
            </ul>
        </div>
    </nav>

    <!-- Page Header -->
    <div class="page-header">
        <div class="container page-header-content">
            <h1 class="page-title">Cast Your Vote</h1>
            <p class="page-subtitle">Select your favorite contestant for The Vivid Dream UGT 25</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Voting Steps -->
        <div class="voting-steps">
            <div class="steps-container">
                <div class="step active" id="step1">
                    <div class="step-number">1</div>
                    <div class="step-text">
                        <span class="step-label">Step 1</span>
                        <span class="step-title">Verify Ticket</span>
                    </div>
                </div>
                <div class="step" id="step2">
                    <div class="step-number">2</div>
                    <div class="step-text">
                        <span class="step-label">Step 2</span>
                        <span class="step-title">Choose Contestant</span>
                    </div>
                </div>
                <div class="step" id="step3">
                    <div class="step-number">3</div>
                    <div class="step-text">
                        <span class="step-label">Step 3</span>
                        <span class="step-title">Submit Vote</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ticket Verification -->
        <div class="ticket-section">
            <div class="ticket-header">
                <div class="ticket-icon">
                    <i class="fas fa-ticket-alt"></i>
                </div>
                <div class="ticket-title">
                    <h3>Enter Your Voting Ticket</h3>
                    <p>Your unique seat code (e.g., D13.1, A2.R3.5)</p>
                </div>
            </div>
            <div class="ticket-input-group">
                <div class="ticket-input-wrapper">
                    <input 
                        type="text" 
                        id="ticketCode" 
                        class="form-control ticket-input" 
                        placeholder="D13.1 or A2.R3.5" 
                        maxlength="10"
                        autocomplete="off"
                    >
                </div>
                <button id="verifyTicket" class="btn btn-primary btn-lg">
                    <i class="fas fa-check-circle"></i>
                    Verify Ticket
                </button>
            </div>
            <div id="ticketStatus" style="display: none;"></div>
        </div>

        <!-- Contestants Section -->
        <div class="contestants-section" id="contestantsSection" style="opacity: 0.5; pointer-events: none;">
            <div class="contestants-header">
                <h2>Choose Your Favorite Contestant</h2>
                <p class="lead">Click on a contestant card to select them for voting</p>
            </div>
            <div id="contestantsGrid" class="contestants-grid">
                <div class="loading-container">
                    <div class="spinner"></div>
                    <div class="loading-text">Loading contestants...</div>
                </div>
            </div>

            <!-- Submit Vote Button -->
            <div class="submit-section" style="display: none;" id="submitSection">
                <h3 class="mb-3">Ready to Submit Your Vote?</h3>
                <p class="text-muted mb-4">You have selected: <strong id="selectedContestantName">-</strong></p>
                <button id="submitVote" class="btn btn-primary submit-button" disabled>
                    <i class="fas fa-paper-plane"></i>
                    Submit Vote
                </button>
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div class="modal-backdrop" id="successBackdrop"></div>
    <div class="modal" id="successModal">
        <div class="modal-header">
            <h3 class="modal-title">Vote Submitted Successfully!</h3>
        </div>
        <div class="modal-body text-center">
            <div style="font-size: 4rem; color: var(--success-color); margin-bottom: var(--spacing-lg);">
                <i class="fas fa-check-circle"></i>
            </div>
            <h4 class="mb-3">Thank you for voting!</h4>
            <p>Your vote for <strong id="votedContestantName"></strong> has been recorded.</p>
            <p class="text-muted">Enjoy the rest of The Vivid Dream event!</p>
        </div>
        <div class="modal-footer">
            <a href="/" class="btn btn-primary">
                <i class="fas fa-home"></i>
                Back to Home
            </a>
        </div>
    </div>

    <!-- Error Modal -->
    <div class="modal-backdrop" id="errorBackdrop"></div>
    <div class="modal" id="errorModal">
        <div class="modal-header">
            <h3 class="modal-title">
                <i class="fas fa-exclamation-circle text-danger"></i>
                Error
            </h3>
            <button class="modal-close" onclick="closeErrorModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <p id="errorMessage"></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeErrorModal()">Close</button>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        // Global variables
        let validTicket = null;
        let contestants = [];
        let selectedContestant = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadContestants();
            setupEventListeners();
        });

        function setupEventListeners() {
            document.getElementById('verifyTicket').addEventListener('click', verifyTicket);
            document.getElementById('ticketCode').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    verifyTicket();
                }
            });
            // Removed auto-uppercase since ticket codes use mixed case (e.g., A2.R3.5)
            document.getElementById('submitVote').addEventListener('click', submitVote);
        }

        async function verifyTicket() {
            const ticketCode = document.getElementById('ticketCode').value.trim();
            const statusDiv = document.getElementById('ticketStatus');
            const verifyBtn = document.getElementById('verifyTicket');

            if (!ticketCode) {
                showTicketStatus('Please enter a ticket code', false);
                return;
            }

            // No fixed length validation since ticket codes vary (D13.1, A2.R3.5, etc.)

            // Disable button during verification
            verifyBtn.disabled = true;
            verifyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

            try {
                const response = await fetch('/api/ticket/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ ticket_code: ticketCode })
                });

                const data = await response.json();

                if (response.ok && data.valid) {
                    validTicket = ticketCode;
                    showTicketStatus('<i class="fas fa-check-circle"></i> Valid ticket! You can now select a contestant.', true);
                    enableVoting();
                    updateSteps(2);
                } else {
                    showTicketStatus('<i class="fas fa-times-circle"></i> ' + (data.message || 'Invalid ticket or already used'), false);
                }
            } catch (error) {
                console.error('Error verifying ticket:', error);
                showTicketStatus('<i class="fas fa-exclamation-triangle"></i> Connection error. Please try again.', false);
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.innerHTML = '<i class="fas fa-check-circle"></i> Verify Ticket';
            }
        }

        function showTicketStatus(message, isValid) {
            const statusDiv = document.getElementById('ticketStatus');
            statusDiv.style.display = 'flex';
            statusDiv.innerHTML = message;
            statusDiv.className = isValid ? 'ticket-status valid' : 'ticket-status invalid';
        }

        function enableVoting() {
            const contestantsSection = document.getElementById('contestantsSection');
            contestantsSection.style.opacity = '1';
            contestantsSection.style.pointerEvents = 'auto';
            
            // Enable vote buttons
            document.querySelectorAll('.vote-button').forEach(btn => {
                btn.classList.add('enabled');
                btn.textContent = 'Select This Contestant';
            });
        }

        function updateSteps(activeStep) {
            for (let i = 1; i <= 3; i++) {
                const step = document.getElementById(`step${i}`);
                if (i < activeStep) {
                    step.classList.add('completed');
                    step.classList.remove('active');
                } else if (i === activeStep) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else {
                    step.classList.remove('active', 'completed');
                }
            }
        }

        async function loadContestants() {
            try {
                const response = await fetch('/api/contestants');
                const data = await response.json();
                contestants = data;
                renderContestants();
            } catch (error) {
                console.error('Error loading contestants:', error);
                document.getElementById('contestantsGrid').innerHTML = 
                    '<div class="alert alert-danger"><i class="fas fa-exclamation-triangle"></i> Unable to load contestants. Please refresh the page.</div>';
            }
        }

        function renderContestants() {
            const grid = document.getElementById('contestantsGrid');
            
            if (contestants.length === 0) {
                grid.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle"></i> No contestants available at this time.</div>';
                return;
            }

            grid.innerHTML = contestants.map((contestant, index) => `
                <div class="contestant-card" data-id="${contestant.id}" onclick="selectContestant(${contestant.id})">
                    <div class="selection-badge">
                        <i class="fas fa-check"></i>
                    </div>
                    <img 
                        src="${contestant.image_url || '/images/default-avatar.svg'}" 
                        alt="${contestant.name}" 
                        class="contestant-image"
                        onerror="this.src='/images/default-avatar.svg'"
                    >
                    <div class="contestant-info">
                        <span class="contestant-number">Contestant #${index + 1}</span>
                        <h3 class="contestant-name">${contestant.name}</h3>
                        <button class="vote-button" onclick="event.stopPropagation(); selectContestant(${contestant.id})">
                            Select This Contestant
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function selectContestant(contestantId) {
            if (!validTicket) {
                showError('Please verify your ticket before selecting a contestant');
                return;
            }

            selectedContestant = contestants.find(c => c.id === contestantId);
            
            if (selectedContestant) {
                // Update UI
                document.querySelectorAll('.contestant-card').forEach(card => {
                    card.classList.remove('selected');
                });
                document.querySelector(`[data-id="${contestantId}"]`).classList.add('selected');
                
                // Show submit section
                document.getElementById('submitSection').style.display = 'block';
                document.getElementById('selectedContestantName').textContent = selectedContestant.name;
                document.getElementById('submitVote').disabled = false;
                
                // Update steps
                updateSteps(3);
                
                // Scroll to submit section
                document.getElementById('submitSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        async function submitVote() {
            if (!selectedContestant || !validTicket) {
                showError('Please select a contestant and verify your ticket');
                return;
            }

            const submitBtn = document.getElementById('submitVote');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';

            try {
                const response = await fetch('/api/vote', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contestant_id: selectedContestant.id,
                        ticket_code: validTicket
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    // Show success modal
                    document.getElementById('votedContestantName').textContent = selectedContestant.name;
                    showSuccessModal();
                } else {
                    showError(data.error || 'Unable to submit vote. Please try again.');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Vote';
                }
            } catch (error) {
                console.error('Error submitting vote:', error);
                showError('Connection error. Please try again.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Submit Vote';
            }
        }

        function showSuccessModal() {
            document.getElementById('successBackdrop').classList.add('show');
            document.getElementById('successModal').classList.add('show');
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorBackdrop').classList.add('show');
            document.getElementById('errorModal').classList.add('show');
        }

        function closeErrorModal() {
            document.getElementById('errorBackdrop').classList.remove('show');
            document.getElementById('errorModal').classList.remove('show');
        }
    </script>
</body>
</html>